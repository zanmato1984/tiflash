# Work in Progress

- Objectives review: confirm `docs/design/2026-01-14-tiforth.md` objectives are met after MS2 follow-ups; if anything missing, break into actionable tasks; otherwise derive a new To Do list focused on code quality/readability/testability.

# To Do

# (none)

# Completed
- Core TiForth + TiFlash guarded integration: Arrow-native pipeline framework + operators (Projection/Filter/HashAgg/HashJoin/Sort) plus Block<->Arrow conversion + gtests; functions integrated via Arrow compute registry overlay + MetaFunction overrides; milestone docs kept in `docs/design/2026-01-14-tiforth-milestone-*.md`.
- Semantics parity expansion (common path): TiDB collations (binary/pad/general_ci/unicode_ci 0400/0900) with vectorized compare + minimal coercion; decimal `add` parity (decimal+decimal + decimal+int) with TiFlash infer/overflow; packed MyTime temporal scalars including week/yearweek.
- External host surface: minimal `tiforth_capi` C ABI with engine/pipeline/task, expression builder, and Arrow C Data Interface push/pull; smoke test runs filter+projection pipeline via C.
- Collation-aware hashing: port TiDB collator sort-key generation into TiForth (`SortKeyString`), use it to normalize HashAgg/HashJoin string keys for `GeneralCI` + Unicode CI (0400/0900, incl 0900 no-pad); hash uses stable FNV on normalized bytes; tests added (TiForth: `libs/tiforth/tests/tiforth_hash_agg_test.cpp`, `libs/tiforth/tests/tiforth_hash_join_test.cpp`; TiFlash: `dbms/src/Flash/tests/gtest_tiforth_block_runner.cpp`).
- Packed MyTime TiDB scalars: add Arrow scalar funcs `tidbDayOfWeek`/`tidbWeekOfYear`/`yearWeek` for packed MyDate/MyDateTime (UInt64 + `MyTimeOptions`), return null on invalid (month/day zero) and match TiFlash week modes (`week(3)` / `yearWeek(mode=2)`); wire `tiforth::Expr` options for these names; tests (TiForth: `libs/tiforth/tests/tiforth_mytime_temporal_test.cpp`; TiFlash: `dbms/src/Flash/tests/gtest_tiforth_block_runner.cpp`).
- C ABI follow-ups: refine `tiforth_capi` ownership rules (Arrow C structs treated as moved-in), add ArrowArrayStream input/output helpers, and add negative/misuse tests for error mapping/ownership (`libs/tiforth/include/tiforth_c/tiforth.h`, `libs/tiforth/src/tiforth_capi/tiforth_capi.cc`, `libs/tiforth/tests/tiforth_capi_smoke_test.cpp`).
- MS10 Expr compilation: remove Arrow `MetaFunction` overrides (can’t bind in Arrow `Expression`), add `tiforth/detail/expr_compiler` to compile `tiforth::Expr` into bound Arrow compute `Expression` with compile-time dispatch (`add`->`tiforth.decimal_add`, `equal/less/...`->`tiforth.collated_*`, packed MyTime hour/minute/second via `tiforth.mytime_*` + options), execute via `ExecuteScalarExpression`, and cache bound expressions in Projection/Filter/HashAgg; updated docs/tests; builds: `ninja -C libs/tiforth/build-debug && ctest`, `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && gtests_dbms --gtest_filter=TiForth*`. Files: `libs/tiforth/include/tiforth/detail/expr_compiler.h`, `libs/tiforth/src/tiforth/detail/expr_compiler.cc`, `libs/tiforth/src/tiforth/expr.cc`, `libs/tiforth/src/tiforth/operators/{projection,filter,hash_agg}.cc`, `libs/tiforth/src/tiforth/functions/scalar/{arithmetic/add,comparison/collated_compare,temporal/mytime}.cc`, `libs/tiforth/tests/tiforth_decimal_add_test.cpp`, docs in `docs/design/2026-01-14-tiforth-milestone-{3,8,10}-*.md`.
- Objectives review: current `docs/design/2026-01-14-tiforth.md` milestones (MS1-9 + MS10 follow-up) are implemented for the “common path”; derived next To Do list focused on docs sync, memory-pool propagation, collated sort perf, and a public compiled-expr API. Files: `.codex/progress/daemon.md`.
- Docs sync: mark MS1-9 milestone docs as implemented, and add MS10 mention to `docs/design/2026-01-14-tiforth.md`. Files: `.codex/progress/daemon.md`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-{1..9}-*.md`. Builds: `ninja -C libs/tiforth/build-debug && ctest`.
- Memory pool propagation: require `Engine*` for `SortTransformOp`/`HashJoinTransformOp` and default Arrow `ExecContext` to engine pool/registry (avoid accidental `arrow::default_memory_pool()`); add `TiForthMemoryPoolTest.HashJoinUsesEnginePool`; update TiFlash gtests to pass engine into join op factories. Files: `libs/tiforth/include/tiforth/operators/{sort,hash_join}.h`, `libs/tiforth/src/tiforth/operators/{sort,hash_join}.cc`, `libs/tiforth/tests/tiforth_{memory_pool,sort,hash_join}_test.cpp`, `dbms/src/Flash/tests/gtest_tiforth_{pipeline_translate,type_mapping,block_runner}.cpp`. Builds: `ninja -C libs/tiforth/build-debug && ctest`, `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && gtests_dbms --gtest_filter=TiForth*`.
- Public compiled expr API: add public `tiforth::CompiledExpr` + `CompileExpr/ExecuteExpr*` (`tiforth/compiled_expr.h`) and migrate operators/`EvalExpr*` to use it instead of `tiforth/detail/expr_compiler.h`. Keep compiler internals under `detail/*` and expose a stable wrapper. Files: `libs/tiforth/include/tiforth/compiled_expr.h`, `libs/tiforth/src/tiforth/compiled_expr.cc`, `libs/tiforth/src/tiforth/CMakeLists.txt`, `libs/tiforth/src/tiforth/{expr,operators/{filter,projection,hash_agg}}.cc`. Builds: `ninja -C libs/tiforth/build-debug && ctest`, `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && gtests_dbms --gtest_filter=TiForth*`.
- Collated string sort perf: precompute per-row normalized sort keys (weight strings) via `SortKeyString` and sort by normalized bytes (stable_sort) to avoid repeated UTF-8 decode/weighting in comparator; add gtests for padding-bin/general-ci/unicode-ci 0900. Files: `libs/tiforth/src/tiforth/operators/sort.cc`, `libs/tiforth/tests/tiforth_sort_test.cpp`. Builds: `ninja -C libs/tiforth/build-debug && ctest`, `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && gtests_dbms --gtest_filter=TiForth*`.
