# Work in Progress

- Decimal mixed-type arithmetic (common path): extend `add` dispatch to support `decimal +/- int` by porting TiFlash cast + infer rules into TiForth; add tests for precision/scale + overflow parity.
- Packed-MyTime temporal functions expansion: add a few more TiDB/TiFlash temporal scalars on packed `MyDate/MyDateTime` (e.g. `toDayOfWeek`, `toWeek`, `toYearWeek`), integrated into Arrow registry with `MyTimeOptions`; add unit tests.
- C ABI stabilization follow-up: audit `tiforth_capi` surface (ownership/error/memory rules), define a minimal stable Engine/Pipeline/Task API, and add a smoke test that executes a simple projection/filter pipeline via C.

# To Do

# Completed
- Collation compare vectorization: reduce per-row overhead in collated string comparisons by moving collation compare/trim helpers inline and dispatching once per kernel invocation. Decisions: `tiforth/collation.h` provides `CompareString<CollationKind>` + `RightTrimAsciiSpace` + `CompareBinary` (no per-call kind branch); collated compare kernel switches on `CollationKind` once per batch and calls templated impl; split exec for `BinaryLike` vs `LargeBinaryLike` to avoid per-element type-id branching; sortâ€™s custom string comparator also dispatches once on collation kind. Files: `libs/tiforth/include/tiforth/collation.h`, `libs/tiforth/src/tiforth/collation.cc`, `libs/tiforth/src/tiforth/functions/scalar/comparison/collated_compare.cc`, `libs/tiforth/src/tiforth/operators/sort.cc`, `libs/tiforth/tests/tiforth_collation_compare_test.cpp`, `libs/tiforth/tests/tiforth_sort_test.cpp`, `.codex/progress/daemon.md`. Tests: `ninja -C libs/tiforth/build-debug && ctest --test-dir libs/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && ./cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter='TiForth*'`.
- Review overall objectives and derive next ToDos: milestone 1-9 goals in `docs/design/2026-01-14-tiforth.md` appear satisfied for TiFlash-local scope (TiForth library, Arrow boundary, TiFlash guarded integration + gtests); remaining gaps are mostly semantic parity expansion (collation coercibility, temporal funcs, decimal casts) and external-host ABI work. Files: `.codex/progress/daemon.md`. Notes: TiDB/TiKV integration is future/out-of-repo; focus next on semantics hooks + ABI hardening.
- MS2-followup: Reorg TiForth functions by Arrow compute categories + packed-MyTime temporal scalars. Decisions: move kernels under `libs/tiforth/src/tiforth/functions/scalar/{arithmetic,comparison,temporal}` and keep `functions/register.cc` as category aggregator; implement packed `MyDate/MyDateTime` (UInt64) extraction functions `toYear/toMonth/toDayOfMonth/toMyDate` and intercept `hour/minute/second/microSecond` via Arrow `MetaFunction` only when called with `MyTimeOptions` (logical type + fsp) so non-packed timestamp inputs still use Arrow kernels; propagate `toMyDate` output logical type in expr/projection for nested calls + schema metadata. Files: `libs/tiforth/src/tiforth/CMakeLists.txt`, `libs/tiforth/src/tiforth/functions/register.cc`, `libs/tiforth/src/tiforth/functions/scalar/arithmetic/add.cc`, `libs/tiforth/src/tiforth/functions/scalar/comparison/collated_compare.cc`, `libs/tiforth/src/tiforth/functions/scalar/temporal/mytime.{h,cc}`, `libs/tiforth/src/tiforth/expr.cc`, `libs/tiforth/src/tiforth/operators/projection.cc`, `libs/tiforth/include/tiforth/functions/collated_compare.h`, `libs/tiforth/include/tiforth/functions/scalar/comparison/collated_compare.h`, `libs/tiforth/tests/tiforth_mytime_temporal_test.cpp`, `.codex/progress/daemon.md`. Tests: `ninja -C libs/tiforth/build-debug && ctest --test-dir libs/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && ./cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter='TiForth*'`.
- MS2: Replace TiForth custom `FunctionRegistry` with Arrow compute registry integration. Decisions: `Engine` owns an `arrow::compute::FunctionRegistry` overlay (parent=Arrow global); register TiForth kernels under `tiforth.*` and override standard names (`add`, `equal/less/...`) via Arrow `MetaFunction` dispatch that delegates to parent for non-tricky types; collation passed via TiForth `FunctionOptions` built in expression evaluation from Arrow `Field` metadata; custom kernels split into `libs/tiforth/src/tiforth/functions/{decimal,string}`. Files: `libs/tiforth/include/tiforth/{engine,tiforth}.h`, `libs/tiforth/include/tiforth/functions/{register,collated_compare}.h`, `libs/tiforth/src/tiforth/{engine,expr}.cc`, `libs/tiforth/src/tiforth/functions/{register,decimal/add,string/collated_compare}.cc`, `libs/tiforth/src/tiforth/operators/{filter,hash_agg,projection}.cc`, `docs/design/2026-01-14-tiforth-milestone-{3,8}-*.md`, `.codex/progress/daemon.md`. Tests: `ninja -C libs/tiforth/build-debug && ctest --test-dir libs/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && ./cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter 'TiForth*'`. Notes: decimal add still only common decimal+decimal path; collation mismatch returns NOT_IMPLEMENTED.
- MS8F: TiForth self-implemented scalar function framework + decimal/string semantics. Decisions: add `FunctionRegistry` + `TypedDatum` wrapper carrying logical type metadata; dispatch `Expr::Call` via registry with Arrow compute fallback; implement `add(decimal,decimal)` using TiFlash `PlusDecimalInferer` (prec/scale) and exact scale alignment; move collation-aware string comparisons (`equal/less/...`) into registry overrides; projection preserves input field metadata for field refs and emits decimal logical metadata for computed decimals. Files: `libs/tiforth/include/tiforth/{engine,expr,function_registry}.h`, `libs/tiforth/src/tiforth/{engine,expr,function_registry}.cc`, `libs/tiforth/include/tiforth/operators/{filter,hash_agg,projection}.h`, `libs/tiforth/src/tiforth/operators/{filter,hash_agg,projection}.cc`, `libs/tiforth/tests/*`, `dbms/src/Flash/tests/gtest_tiforth_{block_runner,pipeline_translate,type_mapping}.cpp`, `docs/design/2026-01-14-tiforth-milestone-{3,8}-*.md`, `.codex/progress/daemon.md`. Tests: `ninja -C libs/tiforth/build-debug && ctest --test-dir libs/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && ./cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=TiForth*`. Notes: only decimal+decimal common path; collation mismatch returns NOT_IMPLEMENTED (no coercibility yet).
- MS1-7: TiForth library/framework + operators + host hooks. Notes: Arrow `RecordBatch` boundary; pipeline/task APIs; Projection/Filter/HashAgg/Sort/HashJoin common path; memory pool + spill hook skeleton; C ABI stubs. Files: `libs/tiforth/include/tiforth/*`, `libs/tiforth/src/tiforth/*`, `libs/tiforth/src/tiforth_capi/*`, `docs/design/2026-01-14-tiforth-milestone-{1..7}-*.md`.
- MS8: TiFlash type->Arrow mapping contract + semantics hooks. Notes: Decimal precision/scale + Decimal128/256; MyDate/MyDateTime packed uint64; strings as Arrow `binary` + collation id metadata; collation-aware compare/hash/sort/group/join keys (BINARY + PAD SPACE BIN). Files: `dbms/src/Flash/TiForth/ArrowTypeMapping.{h,cpp}`, `libs/tiforth/include/tiforth/{type_metadata.h,collation.h}`, `libs/tiforth/src/tiforth/{type_metadata.cc,collation.cc,expr.cc}`, `docs/design/2026-01-14-tiforth-milestone-8-type-mapping.md`.
- MS9-10: TiFlash-first host integration + end-to-end gtests. Notes: Arrow<->Block conversion with metadata roundtrip (collation via side-channel); `RunTiForthPipelineOnBlocks` adapter; gtests covering filter/agg/join with composite keys + decimal/date-time/collated strings; docs synced. Files: `dbms/src/Flash/TiForth/{ArrowBlockConversion,BlockPipelineRunner}.{h,cpp}`, `dbms/src/Flash/tests/gtest_tiforth_*.cpp`, `docs/design/2026-01-14-tiforth-milestone-9-host-integration.md`.
- Collation coercibility + full collator set (common path): port TiDB collations into TiForth and allow mixed-collation predicate compares on the common path. Decisions: add `CollationKind` for `GeneralCI` + Unicode CI (0400/0900) and ship the LUT as `tiforth::tidb::*` (no TiFlash symbol deps); `Expr` resolves string collation by kind (BINARY wins over PAD SPACE BIN), options carry only collation id; collated compare kernels dispatch once per batch and call `CompareString<CollationKind>`; sort now supports all TiDB collations, hash join/agg still gate to BINARY+PAD BIN only. Files: `libs/tiforth/include/tiforth/collation.h`, `libs/tiforth/include/tiforth/detail/tidb_collation_lut.h`, `libs/tiforth/src/tiforth/detail/tidb_collation_lut.cc`, `libs/tiforth/src/tiforth/{collation,expr}.cc`, `libs/tiforth/src/tiforth/functions/scalar/comparison/collated_compare.cc`, `libs/tiforth/src/tiforth/operators/{sort,hash_agg,hash_join}.cc`, `libs/tiforth/tests/tiforth_collation_compare_test.cpp`, `dbms/src/Flash/tests/gtest_tiforth_block_runner.cpp`, `.codex/progress/daemon.md`. Tests: `ninja -C libs/tiforth/build-debug && ctest --test-dir libs/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && ./cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter='TiForthBlockRunnerTest.FilterMixedStringCollationCoercibility'`.
