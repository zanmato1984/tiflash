# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

- Commit TiFlash comparison/logical parity changes (gtests + ArrowBlockConversion fix + docs + progress tracking)

# To Do

- Review objectives; derive next To Do list

# Completed
- TiForth numeric/bitwise arithmetic parity: added TiForth Arrow compute scalar kernels matching TiFlash/TiDB semantics for `bitAnd/bitOr/bitXor/bitNot/bitShiftLeft/bitShiftRight`, `abs/negate`, `intDiv/intDivOrZero`, integer `modulo`, `gcd/lcm`; added extensive TiForth gtests and extended TiFlash parity gtests (TiFlash `executeFunction(...)` vs TiForth Projection). Decisions: implement as custom `ScalarFunction` kernels registered into engine registry overlay (override where needed), keep decimal arithmetic registrar separate and add arithmetic registrar aggregator; parity uses `raw_function_test=true` for `intDivOrZero`/`gcd`/`lcm` (unsupported in DAG analyzer). Files (tiforth repo): `src/tiforth/functions/scalar/arithmetic/numeric_arithmetic.cc`, `src/tiforth/functions/scalar/arithmetic/register.cc`, `src/tiforth/functions/scalar/arithmetic/decimal_arithmetic.cc`, `src/tiforth/CMakeLists.txt`, `tests/tiforth_numeric_arithmetic_test.cpp`, `tests/CMakeLists.txt`, `docs/operators_and_functions.md`. Files (tiflash repo): `dbms/src/Flash/tests/gtest_tiforth_arithmetic_parity.cpp`, `docs/design/2026-01-14-tiforth-milestone-3-projection-scalar-functions.md`, `.codex/progress/daemon.md`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms '--gtest_filter=FunctionTest.TiForthArithmeticParity*'`. Commit (tiforth): `6dbd883`.
- TiForth decimal arithmetic parity (TiFlash semantics) + tests + docs: added Arrow compute `ScalarFunction`s `tiforth.decimal_add/subtract/multiply/divide/tidb_divide/modulo` with TiFlash inference rules (prec<=65, scale<=30) and compile-time rewrites for decimal args; added TiForth gtests covering mixed decimal/int inputs, scale/precision inference, overflow, div-by-zero behavior (NULL for `tidbDivide`/`modulo`); added TiFlash parity gtests invoking TiForth Projection and comparing to TiFlash `executeFunction(...)` results/errors; updated docs. Decisions: keep semantics in custom kernels + compile-time rewrite (avoid Arrow MetaFunction override); compute internally in `arrow::Decimal256` and assert precision/scale constraints. Files (tiforth repo): `src/tiforth/functions/scalar/arithmetic/decimal_arithmetic.cc`, `src/tiforth/detail/expr_compiler.cc`, `src/tiforth/CMakeLists.txt`, `tests/tiforth_decimal_arithmetic_test.cpp`, `tests/CMakeLists.txt`, `docs/operators_and_functions.md`, `docs/type_mapping_tidb_to_arrow.md`. Files (tiflash repo): `dbms/src/Flash/tests/gtest_tiforth_arithmetic_parity.cpp`, `docs/design/2026-01-14-tiforth-milestone-3-projection-scalar-functions.md`, `.codex/progress/daemon.md`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=FunctionTest.TiForthArithmeticParity*`. Commit (tiforth): `b0444dd`.
- TiFlash TiForth executor mode (pass-through) + tri-mode gtests: added runtime setting `enable_tiforth_executor`; `queryExecute` gains a TiForth path (guarded) that currently supports only pass-through DAG (single TableScan/PartitionTableScan/ExchangeReceiver) and throws `NOT_IMPLEMENTED` otherwise; added `DB::TiForth::TiForthQueryExecutor` (BlockInputStream -> Blocks, runs a pass-through TiForth pipeline via `RunTiForthPipelineOnBlocks`); extended `ExecutorTest` runner from bool to 3-value state (dag/pipeline/tiforth) and updated existing `{false,true}` wrappers; added a minimal table-scan pass-through gtest. Decisions: keep unsupported DAG shapes failing (visibility for missing operators); keep implementation Block-based and buffered (tests first). Files: `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/executeQuery.cpp`, `dbms/src/Flash/TiForth/TiForthQueryExecutor.h`, `dbms/src/Flash/TiForth/TiForthQueryExecutor.cpp`, `dbms/src/TestUtils/ExecutorTestUtils.h`, `dbms/src/TestUtils/ExecutorTestUtils.cpp`, `dbms/src/Flash/tests/gtest_tiforth_query_executor_passthrough.cpp`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-9-host-integration.md`, `.codex/progress/daemon.md`. Checks: `cmake -S . -B cmake-build-tiflash-tiforth-debug`, `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms`, `gtests_dbms --gtest_filter=TiForthQueryExecutorPassThroughTestRunner.TableScanPassThrough`. Notes: many existing gtests will fail in tiforth mode until DAG->TiForth translation/operator coverage is expanded. Commit: `685723ca74`.
- TiForth + TiFlash (MS1-10 common path): Arrow-native Engine/Pipeline/Task + operators + function registry + C ABI; TiDB semantics via Arrow field metadata (collations/decimals/MyTime); memory pool propagation; TiFlash guarded integration behind `ENABLE_TIFORTH` with Block<->Arrow bridge + DAG->pipeline translation + gtests. Notes: objective review done; no remaining To Do.
- Docs + packaging: milestone/design docs reconciled; user-facing docs under `libs/tiforth/docs`; install-tree hygiene (no internal headers) + `verify_install.sh` consumer check.
- Repo split: extracted `libs/tiforth` history to standalone repo `zanmato1984/tiforth` (split tip `3c68077ade7d0c4ee0677b732ff80e7d02daabe6`), cloned to `~/dev/tiforth`; TiFlash updated for external TiForth (ignore `libs/tiforth`, FetchContent fallback to the new repo when in-tree source missing). Files: `.gitignore`, `libs/CMakeLists.txt`, `.codex/progress/daemon.md`. Checks: `cmake --preset debug && cmake --build --preset debug && ctest --preset debug` (tiforth repo), `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=TiForth*`.
- TiForth comparison + logical parity: added TiForth logical kernels `and/or/xor/not` (varargs, numeric truthiness, 3VL null semantics) and TiFlash comparison alias normalization (`equals/notEquals/lessOrEquals/greaterOrEquals` -> Arrow compute `equal/not_equal/less_equal/greater_equal`); added TiForth gtests; added TiFlash parity gtests covering numeric/decimal comparisons, collated string comparisons (padding BIN, general CI, mixed collation), and logical ops; updated milestone-3 + TiForth user docs; fixed TiFlash Arrow->Block conversion to safely use `ARROW_ASSIGN_OR_RAISE` in bool->UInt8 mapping. Decisions: Arrow varargs kernels must declare >=2 input types when using `Arity::VarArgs(2)`; keep collation dispatch via `tiforth.collated_*` + `FunctionOptions` derived from Arrow field metadata; normalize TiFlash names during TiForth compilation (avoid Arrow meta-function overrides). Files (tiforth repo): `src/tiforth/functions/scalar/logical/logical.cc`, `src/tiforth/detail/expr_compiler.cc`, `src/tiforth/functions/register.cc`, `src/tiforth/CMakeLists.txt`, `tests/tiforth_logical_test.cpp`, `tests/tiforth_comparison_test.cpp`, `tests/CMakeLists.txt`, `docs/operators_and_functions.md`. Files (tiflash repo): `dbms/src/Flash/tests/gtest_tiforth_comparison_logical_parity.cpp`, `dbms/src/Flash/TiForth/ArrowBlockConversion.cpp`, `docs/design/2026-01-14-tiforth-milestone-3-projection-scalar-functions.md`, `.codex/progress/daemon.md`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=FunctionTest.TiForthArithmeticParity*:FunctionTest.TiForthComparisonParity*:FunctionTest.TiForthLogicalParity*`. Commit (tiforth): `12dba84`.
