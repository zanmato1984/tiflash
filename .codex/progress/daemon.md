# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

- Review Overall Work Objectives; derive next To Do list

# Completed
- MS11(C/D) TiFlash integration for breaker hash aggregation: added `RunTiForthPlanOnBlocks` (Block runner support for TiForth `Plan`), updated TiFlash DAG→TiForth translation smoke test to emit a breaker `Plan` for hash agg (build sink + convergent source with shared `HashAggContext`), and extended TiFlash parity gtests to exercise breaker hash aggregation path (group-by and global-agg empty/non-empty; includes collated string keys). Decisions: keep plan runner rejecting blocked IO/await states (not wired yet); parity tests build breaker plan explicitly via `PlanBuilder` and compare to TiFlash DAG builder outputs. Files: `dbms/src/Flash/TiForth/BlockPipelineRunner.{h,cpp}`, `dbms/src/Flash/tests/gtest_tiforth_pipeline_translate.cpp`, `dbms/src/Flash/tests/gtest_tiforth_filter_agg_parity.cpp`, `libs/CMakeLists.txt`, `.codex/progress/daemon.md`. Checks: `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`.
- TiForth numeric/bitwise arithmetic parity: added TiForth Arrow compute scalar kernels matching TiFlash/TiDB semantics for `bitAnd/bitOr/bitXor/bitNot/bitShiftLeft/bitShiftRight`, `abs/negate`, `intDiv/intDivOrZero`, integer `modulo`, `gcd/lcm`; added extensive TiForth gtests and extended TiFlash parity gtests (TiFlash `executeFunction(...)` vs TiForth Projection). Decisions: implement as custom `ScalarFunction` kernels registered into engine registry overlay (override where needed), keep decimal arithmetic registrar separate and add arithmetic registrar aggregator; parity uses `raw_function_test=true` for `intDivOrZero`/`gcd`/`lcm` (unsupported in DAG analyzer). Files (tiforth repo): `src/tiforth/functions/scalar/arithmetic/numeric_arithmetic.cc`, `src/tiforth/functions/scalar/arithmetic/register.cc`, `src/tiforth/functions/scalar/arithmetic/decimal_arithmetic.cc`, `src/tiforth/CMakeLists.txt`, `tests/tiforth_numeric_arithmetic_test.cpp`, `tests/CMakeLists.txt`, `docs/operators_and_functions.md`. Files (tiflash repo): `dbms/src/Flash/tests/gtest_tiforth_arithmetic_parity.cpp`, `docs/design/2026-01-14-tiforth-milestone-3-projection-scalar-functions.md`, `.codex/progress/daemon.md`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms '--gtest_filter=FunctionTest.TiForthArithmeticParity*'`. Commit (tiforth): `6dbd883`.
- TiForth decimal arithmetic parity (TiFlash semantics) + tests + docs: added Arrow compute `ScalarFunction`s `tiforth.decimal_add/subtract/multiply/divide/tidb_divide/modulo` with TiFlash inference rules (prec<=65, scale<=30) and compile-time rewrites for decimal args; added TiForth gtests covering mixed decimal/int inputs, scale/precision inference, overflow, div-by-zero behavior (NULL for `tidbDivide`/`modulo`); added TiFlash parity gtests invoking TiForth Projection and comparing to TiFlash `executeFunction(...)` results/errors; updated docs. Decisions: keep semantics in custom kernels + compile-time rewrite (avoid Arrow MetaFunction override); compute internally in `arrow::Decimal256` and assert precision/scale constraints. Files (tiforth repo): `src/tiforth/functions/scalar/arithmetic/decimal_arithmetic.cc`, `src/tiforth/detail/expr_compiler.cc`, `src/tiforth/CMakeLists.txt`, `tests/tiforth_decimal_arithmetic_test.cpp`, `tests/CMakeLists.txt`, `docs/operators_and_functions.md`, `docs/type_mapping_tidb_to_arrow.md`. Files (tiflash repo): `dbms/src/Flash/tests/gtest_tiforth_arithmetic_parity.cpp`, `docs/design/2026-01-14-tiforth-milestone-3-projection-scalar-functions.md`, `.codex/progress/daemon.md`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=FunctionTest.TiForthArithmeticParity*`. Commit (tiforth): `b0444dd`.
- TiFlash TiForth executor mode (pass-through) + tri-mode gtests: added runtime setting `enable_tiforth_executor`; `queryExecute` gains a TiForth path (guarded) that currently supports only pass-through DAG (single TableScan/PartitionTableScan/ExchangeReceiver) and throws `NOT_IMPLEMENTED` otherwise; added `DB::TiForth::TiForthQueryExecutor` (BlockInputStream -> Blocks, runs a pass-through TiForth pipeline via `RunTiForthPipelineOnBlocks`); extended `ExecutorTest` runner from bool to 3-value state (dag/pipeline/tiforth) and updated existing `{false,true}` wrappers; added a minimal table-scan pass-through gtest. Decisions: keep unsupported DAG shapes failing (visibility for missing operators); keep implementation Block-based and buffered (tests first). Files: `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/executeQuery.cpp`, `dbms/src/Flash/TiForth/TiForthQueryExecutor.h`, `dbms/src/Flash/TiForth/TiForthQueryExecutor.cpp`, `dbms/src/TestUtils/ExecutorTestUtils.h`, `dbms/src/TestUtils/ExecutorTestUtils.cpp`, `dbms/src/Flash/tests/gtest_tiforth_query_executor_passthrough.cpp`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-9-host-integration.md`, `.codex/progress/daemon.md`. Checks: `cmake -S . -B cmake-build-tiflash-tiforth-debug`, `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms`, `gtests_dbms --gtest_filter=TiForthQueryExecutorPassThroughTestRunner.TableScanPassThrough`. Notes: many existing gtests will fail in tiforth mode until DAG->TiForth translation/operator coverage is expanded. Commit: `685723ca74`.
- TiForth + TiFlash (MS1-10 common path): Arrow-native Engine/Pipeline/Task + operators + function registry + C ABI; TiDB semantics via Arrow field metadata (collations/decimals/MyTime); memory pool propagation; TiFlash guarded integration behind `ENABLE_TIFORTH` with Block<->Arrow bridge + DAG->pipeline translation + gtests. Notes: objective review done; no remaining To Do.
- Docs + packaging: milestone/design docs reconciled; user-facing docs under `libs/tiforth/docs`; install-tree hygiene (no internal headers) + `verify_install.sh` consumer check.
- Repo split: extracted `libs/tiforth` history to standalone repo `zanmato1984/tiforth` (split tip `3c68077ade7d0c4ee0677b732ff80e7d02daabe6`), cloned to `~/dev/tiforth`; TiFlash updated for external TiForth (ignore `libs/tiforth`, FetchContent fallback to the new repo when in-tree source missing). Files: `.gitignore`, `libs/CMakeLists.txt`, `.codex/progress/daemon.md`. Checks: `cmake --preset debug && cmake --build --preset debug && ctest --preset debug` (tiforth repo), `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=TiForth*`.
- TiForth comparison + logical parity: added TiForth logical kernels `and/or/xor/not` (varargs, numeric truthiness, 3VL null semantics) and TiFlash comparison alias normalization (`equals/notEquals/lessOrEquals/greaterOrEquals` -> Arrow compute `equal/not_equal/less_equal/greater_equal`); added TiForth gtests; added TiFlash parity gtests covering numeric/decimal comparisons, collated string comparisons (padding BIN, general CI, mixed collation), and logical ops; updated milestone-3 + TiForth user docs; fixed TiFlash Arrow->Block conversion to safely use `ARROW_ASSIGN_OR_RAISE` in bool->UInt8 mapping. Decisions: Arrow varargs kernels must declare >=2 input types when using `Arity::VarArgs(2)`; keep collation dispatch via `tiforth.collated_*` + `FunctionOptions` derived from Arrow field metadata; normalize TiFlash names during TiForth compilation (avoid Arrow meta-function overrides). Files (tiforth repo): `src/tiforth/functions/scalar/logical/logical.cc`, `src/tiforth/detail/expr_compiler.cc`, `src/tiforth/functions/register.cc`, `src/tiforth/CMakeLists.txt`, `tests/tiforth_logical_test.cpp`, `tests/tiforth_comparison_test.cpp`, `tests/CMakeLists.txt`, `docs/operators_and_functions.md`. Files (tiflash repo): `dbms/src/Flash/tests/gtest_tiforth_comparison_logical_parity.cpp`, `dbms/src/Flash/TiForth/ArrowBlockConversion.cpp`, `docs/design/2026-01-14-tiforth-milestone-3-projection-scalar-functions.md`, `.codex/progress/daemon.md`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=FunctionTest.TiForthArithmeticParity*:FunctionTest.TiForthComparisonParity*:FunctionTest.TiForthLogicalParity*`. Commit (tiforth): `12dba84`. Commit (tiflash): `6b01b64d54`.
- Objective review (post comparison/logical parity): confirmed “Overall Work Objectives” still met (standalone tiforth repo, guarded TiFlash integration, Arrow schema contract for semantics, memory pool propagation). Notes: additional parity (more scalar funcs/operators) can be driven incrementally by parity gtests + milestone docs as new requirements arise.
- TiForth Filter + HashAgg parity (common path): ported TiFlash WHERE truthiness (`convertBool`) into TiForth `FilterTransformOp` (numeric/string/binary coercion to bool; NULL dropped); expanded TiForth `HashAggTransformOp` (up to 8 keys; key types: ints/uints/bool/float/double/decimal/binary+collation sort keys; aggs: `count_all`/`count`/`sum`/`min`/`max`; stable output order aggs-first; global agg emits a row even on empty-after-filter); added extensive TiFlash↔TiForth parity gtests including collated string grouping (utf8mb4_bin / general_ci / 0900_ai_ci) + multi-key grouping; fixed TiFlash MockExecutor SUM typing to `Nullable(Int64)` for parity. Decisions: keep truthiness inside filter op (Arrow Filter requires boolean); use TiFlash DAG builder for expected agg outputs (avoid SQL/mock gaps); normalize collated string keys via sort key for hashing/equality, keep first-seen raw key for output. Files (tiforth repo): `src/tiforth/operators/filter.cc`, `src/tiforth/operators/hash_agg.cc`, `include/tiforth/operators/hash_agg.h`, `tests/tiforth_filter_test.cpp`, `tests/tiforth_hash_agg_test.cpp`. Files (tiflash repo): `dbms/src/Flash/tests/gtest_tiforth_filter_agg_parity.cpp`, `dbms/src/Debug/MockExecutor/AggregationBinder.cpp`, `dbms/src/Flash/TiForth/BlockPipelineRunner.{h,cpp}`, `dbms/src/Flash/TiForth/TiForthQueryExecutor.cpp`, `dbms/src/Flash/tests/gtest_{aggregation,projection}_executor.cpp`, `dbms/src/Flash/tests/gtest_tiforth_{block_runner,pipeline_translate,type_mapping}.cpp`, `docs/design/2026-01-14-tiforth-milestone-4-filter-expression-evaluation.md`, `docs/design/2026-01-14-tiforth-milestone-5-hash-aggregation.md`, `.codex/progress/daemon.md`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && LOG_LEVEL=error cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter='TiForthFilterAggParityTestRunner.*:TiForthBlockRunnerTest.*:TiForthPipelineTranslateTest.*:TiForthTypeMappingTest.BlockToArrowAndOperators:AggExecutorTestRunner.RepeatedAggregateFunction:ProjectionExecutorTestRunner.ProjectionThenAgg'`. Commit (tiforth): `c516988`. Notes: TiFlash DAG->TiForth translation is still hardcoded in tests; integrating real filter/hashagg translation into TiFlash executor is the next step.
- MS11 design (planned): documented TiFlash aggregation pipeline-breaker split (AggregationBuild sink + AggregationConvergent source, shared `AggregateContext`) and the target TiForth counterpart (multi-pipeline plan + `HashAggContext` + build sink + convergent source) with a task breakdown for a dedicated agent. Files: `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-3-pipeline-framework.md`, `docs/design/2026-01-14-tiforth-milestone-5-hash-aggregation.md`, `docs/design/2026-01-14-tiforth-milestone-11-pipeline-breaker-hash-aggregation.md`, `.codex/progress/daemon.md`. Checks: `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*'`.
- Docs: clarified TiForth host-provided `SourceOp`/`SinkOp` as the key integration point for storage/network I/O (kept out of tiforth core), and recorded that true pipeline-breaker mirroring requires adopting TiFlash `OperatorStatus` (IO/wait states). Updated MS11 task breakdown accordingly. Files: `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-3-pipeline-framework.md`, `docs/design/2026-01-14-tiforth-milestone-11-pipeline-breaker-hash-aggregation.md`, `.codex/progress/daemon.md`. Notes: doc-only change; tests skipped per request.
- TiForth MS11(A): added multi-stage `Plan` (pipeline DAG) + task-owned breaker state, extended TiForth `OperatorStatus` and `TaskState` to mirror TiFlash status surface (CANCELLED/WAITING/WAIT_FOR_NOTIFY/IO_IN/IO_OUT) and added Task methods + C ABI entrypoints for `execute_io/await/notify`. Decisions: keep existing `Pipeline` API for single-chain common path; add new `Plan` API for breaker plans; keep IO/await semantics TiFlash-shaped via `PipelineExec::{ExecuteIO,Await,Notify}` tracking the blocking operator. Files (tiforth repo): `include/tiforth/{plan,operators,pipeline_exec,task}.h`, `src/tiforth/{plan,pipeline_exec,task,pipeline}.cc`, `include/tiforth_c/tiforth.h`, `src/tiforth_capi/tiforth_capi.cc`, `tests/tiforth_plan_breaker_test.cpp`, `tests/CMakeLists.txt`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`. Commit (tiforth): `39c3a04`.
- TiForth MS11(B): refactored hash aggregation into a shared `HashAggContext` with a breaker split (`HashAggBuildSinkOp` + `HashAggConvergentSourceOp`), kept existing `HashAggTransformOp` working by delegating to the context, and added a TiForth plan breaker gtest for global-agg empty input. Decisions: convergent output chunks are RecordBatch slices of a cached full output batch (preserves MS5 single-batch behavior for `HashAggTransformOp`, enables multi-batch in breaker form). Files (tiforth repo): `include/tiforth/operators/hash_agg.h`, `src/tiforth/operators/hash_agg.cc`, `tests/tiforth_hash_agg_breaker_test.cpp`, `tests/CMakeLists.txt`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`. Commit (tiforth): `e295494`.
