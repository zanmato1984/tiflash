# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

- TiForth Arrow hash aggregation operator (`ArrowHashAggTransformOp`): port Arrow Acero `GroupByNode` core into TiForth operator/pipeline (no Acero plan); drive grouped `hash_*` kernels; make grouper creation pluggable for future custom `arrow::compute::Grouper` (collation + short-string optimizations). Steps: (1) port state machine (consume/finalize), (2) integrate `arrow::compute::Grouper` API + shim, (3) drive grouped kernels, (4) output materialization/schema, (5) unit tests.

# To Do

- TiFlash parity gtests for `ArrowHashAggTransformOp` vs native `DB::Aggregator`: focus on group-by + sum/count/min/max; ignore collation; cover ints/floats/decimal + nulls; cover uniform/zipf/high-cardinality distributions.
- ArrowComputeAgg string keys: prototype optional “build stable dictionary then aggregate” mode (buffer+encode + dict unify) or upstream Arrow dictionary-unification support; keep default string-key fallback to TiForth `HashAggTransformOp`; add microbench + perf notes.

# Completed

- TiForth core + type contract (MS1-13, 2026-01-19): standalone `tiforth` library (Engine/Pipeline/Plan/Task + C ABI skeleton), Arrow logical-type metadata contract (decimal/MyTime/collations), core operators (projection/filter/hash agg/join/sort) with breaker plan semantics + blocked-state model, and optimized hash tables. Key decision: keep TiForth independent (no TiFlash assumptions) while matching Arrow coding style + rigid checks. Files: `libs/tiforth/*`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-*.md`.
- Arrow-compute aggregation + benchmarks (MS14-16, 2026-01-19..2026-01-20): TiForth `ArrowComputeAggTransformOp` via Arrow Acero, TiFlash `bench_dbms` coverage + markdown report + string-key profiling; decision: numeric group keys OK for ArrowComputeAgg, string keys default to TiForth HashAgg (Arrow varlen grouper hot path too costly unless stable dictionary). Added MS15/MS16 design docs for non-Acero `ArrowHashAggTransformOp` + parity gtests. Files: `dbms/src/Flash/tests/bench_tiforth_arrow_compute_agg.cpp`, `docs/design/2026-01-19-arrow-compute-agg-benchmark-report.md`, `docs/design/2026-01-19-arrow-compute-agg-string-key-profiling.md`, `docs/design/2026-01-14-tiforth-milestone-15-arrow-hash-agg-operator.md`, `docs/design/2026-01-14-tiforth-milestone-16-arrow-hash-agg-parity-gtests.md`.
- TiFlash↔TiForth integration + executor runtime + DAG translate (2026-01-19..2026-01-20): Block↔Arrow bridge, query memory accounting via `TiFlashMemoryPool`, streaming Task stepping (`PushInput`/`PullOutput`) + blocked states mapping (`kIOIn/kIOOut/kWaiting/kWaitForNotify`) with gtests; production “translate DAG to TiForth” mode for a small subset (filter/projection/join) with native fallback when unsupported. Fixes: TiForth hash join supports `Int64` (and other integer) keys; join-translate fallback no longer pollutes pipelines; TiForth pass-through no longer emits an empty schema block for empty input (keeps TiFlash test semantics). Validation: `ninja -C cmake-build-debug gtests_dbms`, `gtests_dbms --gtest_filter=TiForth*`, `gtests_dbms --gtest_filter=TiForthDagTranslateParityTestRunner.*:LimitExecutorTestRunner.Limit`. Files: `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/executeQuery.cpp`, `dbms/src/Flash/Planner/Plans/Physical{Filter,Projection,Join,Aggregation}.cpp`, `dbms/src/Flash/TiForth/*`, `dbms/src/Flash/tests/gtest_tiforth_dag_translate_parity.cpp`, `libs/tiforth/src/tiforth/operators/hash_join.cc`, `.codex/progress/daemon.md`.
