# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

# Completed

- TiForth core + type contract (MS1-13, 2026-01-19): standalone `tiforth` library (Engine/Pipeline/Plan/Task + C ABI skeleton), Arrow logical-type metadata contract (decimal/MyTime/collations), core operators (projection/filter/hash agg/join/sort) with breaker plan semantics + blocked-state model, and optimized hash tables. Key decision: keep TiForth independent (no TiFlash assumptions) while matching Arrow coding style + rigid checks. Files: `libs/tiforth/*`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-*.md`.
- Arrow-compute aggregation + benchmarks (MS14-16, 2026-01-19..2026-01-20): TiForth `ArrowComputeAggTransformOp` via Arrow Acero, TiFlash `bench_dbms` coverage + markdown report + string-key profiling; decision: numeric group keys OK for ArrowComputeAgg, string keys default to TiForth HashAgg (Arrow varlen grouper hot path too costly unless stable dictionary). Added MS15/MS16 design docs for non-Acero `ArrowHashAggTransformOp` + parity gtests. Files: `dbms/src/Flash/tests/bench_tiforth_arrow_compute_agg.cpp`, `docs/design/2026-01-19-arrow-compute-agg-benchmark-report.md`, `docs/design/2026-01-19-arrow-compute-agg-string-key-profiling.md`, `docs/design/2026-01-14-tiforth-milestone-15-arrow-hash-agg-operator.md`, `docs/design/2026-01-14-tiforth-milestone-16-arrow-hash-agg-parity-gtests.md`.
- TiFlash↔TiForth integration + executor runtime + DAG translate (2026-01-19..2026-01-20): Block↔Arrow bridge, query memory accounting via `TiFlashMemoryPool`, streaming Task stepping (`PushInput`/`PullOutput`) + blocked states mapping (`kIOIn/kIOOut/kWaiting/kWaitForNotify`) with gtests; production “translate DAG to TiForth” mode for a small subset (filter/projection/join) with native fallback when unsupported. Fixes: TiForth hash join supports `Int64` (and other integer) keys; join-translate fallback no longer pollutes pipelines; TiForth pass-through no longer emits an empty schema block for empty input (keeps TiFlash test semantics). Validation: `ninja -C cmake-build-debug gtests_dbms`, `gtests_dbms --gtest_filter=TiForth*`, `gtests_dbms --gtest_filter=TiForthDagTranslateParityTestRunner.*:LimitExecutorTestRunner.Limit`. Files: `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/executeQuery.cpp`, `dbms/src/Flash/Planner/Plans/Physical{Filter,Projection,Join,Aggregation}.cpp`, `dbms/src/Flash/TiForth/*`, `dbms/src/Flash/tests/gtest_tiforth_dag_translate_parity.cpp`, `libs/tiforth/src/tiforth/operators/hash_join.cc`, `.codex/progress/daemon.md`.
- TiForth `ArrowHashAggTransformOp` (MS15 impl, 2026-01-20): TiForth-native hash aggregation operator (no Acero) using `arrow::compute::Grouper` + grouped `hash_*` kernels; `GrouperFactory` injection hook; supports expression keys/args and emits final batches on EOS (aggs then keys). Validation: TiForth `ctest --test-dir build-debug`, TiFlash `ninja -C cmake-build-debug gtests_dbms` + `gtests_dbms '--gtest_filter=TiForth*'`. Files: TiForth `include/tiforth/operators/arrow_hash_agg.h`, `src/tiforth/operators/arrow_hash_agg.cc`, `tests/tiforth_arrow_hash_agg_test.cpp`, `src/tiforth/CMakeLists.txt`, `tests/CMakeLists.txt`; TiFlash `libs/CMakeLists.txt`, `docs/design/2026-01-14-tiforth-milestone-15-arrow-hash-agg-operator.md`, `.codex/progress/daemon.md`. Notes: group-by without keys not implemented; parity gtests next.
- TiFlash parity gtests for `ArrowHashAggTransformOp` vs native `DB::Aggregator` (MS16 impl, 2026-01-20): add correctness gate for grouped `hash_*` kernels (count/sum/min/max) over int/float/decimal values with null keys/values and multiple key distributions (single/low-card/high-card/zipf). Validation: `ninja -C cmake-build-debug gtests_dbms`, `gtests_dbms '--gtest_filter=TiForthArrowHashAggParityTest.*'`, `gtests_dbms '--gtest_filter=TiForth*'`. Files: `dbms/src/Flash/tests/gtest_tiforth_arrow_hash_agg_parity.cpp`, `docs/design/2026-01-14-tiforth-milestone-16-arrow-hash-agg-parity-gtests.md`, `.codex/progress/daemon.md`. Notes: string-key semantics still out of scope (collation); ArrowComputeAgg string-key perf work next.
- ArrowComputeAgg string keys stable-dict prototype (2026-01-20): add TiFlash opt-in `enable_tiforth_arrow_compute_agg_string_keys` (collation-safe) to allow Acero agg on string keys using TiForth stable-dict mode; implement stable-dict as per-batch `dictionary_encode` + `DictionaryUnifier` to stable `int32` codes, aggregate on codes, decode output keys via `take`; add `bench_dbms` stable-dict benchmark + update benchmark/profiling markdown. Decision: keep default string-key path as TiForth `HashAggTransformOp` (stable-dict still slower than raw keys + Native; only already-dictionary keys are a win). Files: TiForth `include/tiforth/operators/arrow_compute_agg.h`, `src/tiforth/operators/arrow_compute_agg.cc`; TiFlash `dbms/src/Flash/Planner/Plans/PhysicalAggregation.cpp`, `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/tests/bench_tiforth_arrow_compute_agg.cpp`, `docs/design/2026-01-19-arrow-compute-agg-benchmark-report.md`, `docs/design/2026-01-19-arrow-compute-agg-string-key-profiling.md`, `libs/CMakeLists.txt`, `.codex/progress/daemon.md`. Validation: TiForth `ctest --test-dir libs/tiforth/build-debug`; TiFlash `ninja -C cmake-build-release bench_dbms` + `bench_dbms --benchmark_filter '^ArrowComputeAgg/.*'`; TiFlash `ninja -C cmake-build-debug gtests_dbms` + `gtests_dbms --gtest_filter=TiForth*`. Notes: stable-dict overhead dominated by encoding; future wins likely need upstream Arrow improvements or fixed-width/string-specialized key encoding.
- Review objectives (2026-01-20): objectives met (standalone TiForth repo + TiFlash integration + type metadata contract + host memory pool routing). No new To Do added; remaining perf headroom for Arrow/Acero string keys is optional/future work.
- TiFlash switch for TiForth `ArrowHashAggTransformOp` (MS15/16 follow-up, 2026-01-20): add TiFlash setting `enable_tiforth_arrow_hash_agg` and planner selection in `PhysicalAggregation` to choose `ArrowComputeAggTransformOp` / `ArrowHashAggTransformOp` / `HashAggTransformOp` (collation-sensitive string GROUP BY still falls back to TiForth HashAgg). Updated MS15/MS16 docs and main TiForth design doc status to MS1-16. Validation: TiForth `ctest --test-dir libs/tiforth/build-debug --output-on-failure`; TiFlash `ninja -C cmake-build-debug gtests_dbms`, `gtests_dbms '--gtest_filter=TiForthArrowHashAggParityTest.*'`, `gtests_dbms '--gtest_filter=TiForth*'`. Files: `dbms/src/Flash/Planner/Plans/PhysicalAggregation.cpp`, `dbms/src/Interpreters/Settings.h`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-15-arrow-hash-agg-operator.md`, `docs/design/2026-01-14-tiforth-milestone-16-arrow-hash-agg-parity-gtests.md`, `.codex/progress/daemon.md`.
- MS16+ parity edge cases + TiForth hash_* overrides (2026-01-20): expanded TiFlash parity gtests to assert output type/nullability and cover empty input, multi-key group-by, NaN/Inf/-0, unsigned types, and an explicit Int64 overflow case. Found + fixed real semantic gaps: ArrowHashAgg output field nullability (Arrow fields default nullable), `hash_count{,_all}` output type (UInt64 vs Int64), and float `hash_min/hash_max` NaN/-0 behavior. Mitigation: TiForth now registers custom grouped hash aggregate functions in its engine function registry (`hash_count`, `hash_count_all`, `hash_sum` decimal out type, `hash_mean` int/decimal, `hash_min/hash_max` float). Also fixed parity harness for multi-key native aggregation (arg index) and empty output handling (mergeAndConvertToBlocks may return null). Files: TiFlash `dbms/src/Flash/tests/gtest_tiforth_arrow_hash_agg_parity.cpp`, `docs/design/2026-01-14-tiforth-milestone-15-arrow-hash-agg-operator.md`, `docs/design/2026-01-14-tiforth-milestone-16-arrow-hash-agg-parity-gtests.md`, `.codex/progress/daemon.md`; TiForth `libs/tiforth/src/tiforth/functions/hash_aggregate.cc`, `libs/tiforth/src/tiforth/operators/arrow_hash_agg.cc`, `libs/tiforth/src/tiforth/functions/register.cc`, `libs/tiforth/src/tiforth/CMakeLists.txt`. Validation: `ninja -C cmake-build-debug gtests_dbms`, `gtests_dbms '--gtest_filter=TiForthArrowHashAggParityTest.*'`.
