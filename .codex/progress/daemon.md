# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

- Docs sync: update TiForth operator docs to match current hash agg/join implementation (key count limit, supported key/agg types, memory notes); cross-check against TiForth gtests
- Memory pool coverage: add TiForth gtest ensuring hash aggregation routes key build + group key arena allocations through Engine `arrow::MemoryPool` (ProxyMemoryPool); cover collated string keys
- Cleanup: deduplicate `ArrowMemoryPoolResource` into a shared TiForth `detail/` header and reuse it in hash agg/join/sort (and any tests), keep no-exception behavior consistent

# Completed

- TiForth core + tests (MS1-11): Arrow-native Engine/Pipeline/Task APIs, expression compilation, operators (projection/filter/hash agg/hash join/sort), type mapping + logical-type metadata (decimal/MyTime/collations), memory pool plumbing, and C ABI scaffolding. Plan breaker infrastructure (multi-stage `Plan`, TiFlash-shaped `OperatorStatus`/`TaskState`) and hash-agg breaker split (`HashAggContext` + build sink + convergent source) are implemented and covered by TiForth gtests.
- TiFlash integration + tests: builds/consumes TiForth behind `TIFLASH_ENABLE_TIFORTH`; Block<->Arrow bridge + runner; `enable_tiforth_executor` pass-through execution path; DAGâ†’TiForth translation smoke tests (incl breaker hash agg plan) and TiFlash parity gtests for filter+agg (collations) + arithmetic. Note: end-to-end blocked IO/await states are not wired; production translation is still incremental.
- Function parity: custom Arrow compute scalar kernels + compile-time rewrites to match TiDB/TiFlash semantics (numeric/bitwise + decimal arithmetic), with TiForth unit tests, TiFlash parity gtests, and operator/function docs updates.
- Hash agg key hash table port (TiForth `147d4be`): added Arrow-pool `detail::Arena` + open-addressing `detail::KeyHashTable` (saved hash, linear probing) and refactored `HashAggContext` to encode normalized key bytes into scratch, probe before copying, and only materialize/store first-seen raw keys on insert; global agg bypass. TiFlash pin bumped to `147d4be`. Docs updated. Tests: `ninja -C cmake-build-debug gtests_dbms` + `cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: `libs/CMakeLists.txt`, `docs/design/2026-01-14-tiforth-milestone-5-hash-aggregation.md`, `docs/design/2026-01-14-tiforth-milestone-5-hash-aggregation-hash-table.md`, `.codex/progress/daemon.md`. Notes: scratch key buffers still use `std::string`; output binary keys still store `std::pmr::string` (pool-backed) only on insert.
- Hash agg aggregate-function framework (TiForth `a354622`): added internal `detail::AggregateFunction` + `detail::ComputeAggStateLayout`; `HashAggContext` now allocates a per-group aggregate state row from an Arrow-pool arena and routes `count_all/count/sum/min/max` through `Create/Add/Finalize/Destroy` instead of ad-hoc per-agg vectors. TiFlash pin bumped to `a354622`. Docs updated. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: (tiforth) `include/tiforth/detail/aggregate_function.h`, `include/tiforth/operators/hash_agg.h`, `src/tiforth/operators/hash_agg.cc`; (tiflash) `libs/CMakeLists.txt`, `docs/design/2026-01-14-tiforth-milestone-5-hash-aggregation-agg-framework.md`, `.codex/progress/daemon.md`. Notes: group key output storage still uses `std::pmr::string` (pool-backed); remaining `std::vector` and scratch buffers still use the default allocator.
- Hash agg pooled containers (TiForth `ff5da88`): `HashAggContext` group key storage (`group_keys_`) and group state pointer table (`group_agg_states_`) are now `std::pmr::vector` allocated from the Arrow-pool `memory_resource` (no per-group `std::vector` heap allocations on group growth). TiFlash pin bumped to `ff5da88`. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: (tiforth) `include/tiforth/operators/hash_agg.h`, `src/tiforth/operators/hash_agg.cc`; (tiflash) `libs/CMakeLists.txt`, `.codex/progress/daemon.md`.
- Hash join key table port (TiForth `3a8428a`): replaced `std::unordered_map` build index with arena-backed `detail::KeyHashTable` keyed by normalized join key bytes; per-key duplicate build rows stored in insertion order via a compact linked list (`key_id -> {head,tail}`, `node -> {build_row,next}`). TiFlash pin bumped to `3a8428a`. Docs updated (`docs/design/2026-01-14-tiforth-milestone-6-join-sort.md`). Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: (tiforth) `include/tiforth/operators/hash_join.h`, `src/tiforth/operators/hash_join.cc`; (tiflash) `libs/CMakeLists.txt`, `docs/design/2026-01-14-tiforth-milestone-6-join-sort.md`, `.codex/progress/daemon.md`.
- Reduce key-path heap allocations (TiForth `bea93b3`): replaced hash agg/join scratch key buffers with Arrow-pool-backed `detail::ScratchBytes` (reusable `arrow::BufferBuilder`), and switched hash-agg output `binary` group keys from owning `std::pmr::string` to arena-backed `detail::ByteSlice`. TiFlash pin bumped to `7db1f7a`. Docs updated (`docs/design/2026-01-14-tiforth-milestone-5-hash-aggregation-hash-table.md`). Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: (tiforth) `include/tiforth/detail/scratch_bytes.h`, `include/tiforth/operators/hash_{agg,join}.h`, `src/tiforth/operators/hash_{agg,join}.cc`, `docs/operators_and_functions.md`; (tiflash) `libs/CMakeLists.txt`, `docs/design/2026-01-14-tiforth-milestone-5-hash-aggregation-hash-table.md`, `.codex/progress/daemon.md`.
- Key hash table stress tests (TiForth `7db1f7a`): added `tiforth_key_hash_table_test` covering rehash/high-cardinality and collision-heavy probing via forced identical hashes. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: (tiforth) `tests/tiforth_key_hash_table_test.cpp`, `tests/CMakeLists.txt`; (tiflash) `.codex/progress/daemon.md`.
- Review: objectives met for MS1-11 common path; derived next To Do list focusing on docs sync + memory pool coverage + minor refactors. Files: `.codex/progress/daemon.md`. Notes: C ABI memory-pool callbacks and deeper TiFlash parity coverage remain follow-ups.
