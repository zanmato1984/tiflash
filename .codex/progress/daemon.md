# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

- MS20: rework ArrowHashAgg into breaker-style HashAgg + remove legacy. Steps: (1) delete legacy hash agg entirely (`LegacyHashAggTransformOp`, `HashAggBuildSinkOp`, `HashAggConvergentSourceOp`, context, tests); (2) rename ArrowHashAgg → HashAgg (`HashAggTransformOp` + new merge sink/result source ops) and remove “ArrowHashAgg” naming across APIs/files/docs/tests/benchmarks/settings/logs; (3) implement partial agg in parallel via `TransformOp`, merge+final via shared `SinkOp`/`SourceOp`, then update TiFlash planner wiring + parity/bench/docs. Design: `docs/design/2026-01-14-tiforth-milestone-20-remove-legacy-hash-agg-rename-hash-agg.md`.
- MS21: explore collation-aware GROUP BY via custom Arrow `Grouper` (and prototype if feasible). Steps: (1) evaluate Arrow `Grouper` contract vs TiFlash collation semantics (normalize-to-sort-key + preserve first-row original key); (2) implement `CollationSingleKeyGrouper` (binary keys, single-key) using TiForth collation key encoding; (3) wire into default `HashAggTransformOp` grouper selection when `collation_id` metadata is present; (4) add parity tests for a small matrix (GeneralCI, simple ASCII cases + nulls). Design: `docs/design/2026-01-14-tiforth-milestone-21-collation-aware-group-by-grouper.md`.

# Completed

- TiForth core + type contract (MS1-13, 2026-01-19): standalone `tiforth` library (Engine/Pipeline/Task + minimal C ABI), Arrow logical-type metadata contract (decimal/MyTime/collations), core operators (projection/filter/hash agg/join/sort) with breaker plan semantics + blocked-state model, and optimized hash tables. Decision: keep TiForth independent (no TiFlash assumptions) while matching Arrow style + rigid checks. Files: `libs/tiforth/*`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-*.md`.
- Arrow-native aggregation track (MS14-19, 2026-01-19..2026-01-21): ArrowComputeAgg (Acero) + non-Acero ArrowHashAgg, parity gtests, string-key stable-dict prototype, MS17 default switch (planner uses ArrowHashAgg by default; legacy renamed to `LegacyHashAggTransformOp` with migration alias), MS18 small-string single-key grouper (`SmallStringSingleKeyGrouper`) wired as ArrowHashAgg default for single binary/string key (collation-sensitive keys stay legacy), MS19 small-string benchmarks + report update. Files: `libs/tiforth/src/tiforth/{operators,detail}/*`, `libs/tiforth/tests/tiforth_{arrow_compute_agg,arrow_hash_agg,small_string_single_key_grouper}_test.cpp`, `dbms/src/Flash/Planner/Plans/PhysicalAggregation.cpp`, `dbms/src/Flash/tests/{gtest_tiforth_arrow_hash_agg_parity,bench_tiforth_arrow_hash_agg_small_string}.cpp`, `docs/design/2026-01-19-arrow-compute-agg-benchmark-report.md`, `docs/design/2026-01-14-tiforth-milestone-{17,18,19}-*.md`. Validation: `ctest --test-dir libs/tiforth/build-debug --output-on-failure`; `ninja -C cmake-build-debug gtests_dbms` + `gtests_dbms --gtest_filter='TiForth*'`; `ninja -C cmake-build-release bench_dbms` + `bench_dbms --benchmark_filter '^(ArrowHashAgg|HashAgg|NativeAgg)/SmallStringSingleKey/.*'`. Notes: collation-aware string grouping still legacy-only; ArrowHashAgg string keys are binary semantics.
- TiFlash↔TiForth integration + executor runtime + DAG translate (2026-01-19..2026-01-21): Block↔Arrow bridge, query memory accounting via `TiFlashMemoryPool`, streaming Task stepping + blocked states mapping with gtests; “translate DAG to TiForth” mode for a small subset with native fallback. Files: `dbms/src/Flash/TiForth/*`, `dbms/src/Flash/tests/gtest_tiforth_*`, `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/executeQuery.cpp`.
