# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

- TiForth: expand aggregate function coverage/types towards TiFlash semantics (at least: `avg`, `sum` for float/decimal, `min/max` for float/decimal; keep collation/decimal/time rules).

# To Do

- TiFlash: extend parity gtests to cover new agg functions/types (pin bumped separately) and ensure breaker path still matches TiFlash results.

# Completed

- TiForth core + TiFlash integration (MS1-11 common path): Engine/Pipeline/Task APIs, expression compilation, operators (projection/filter/hash agg/hash join/sort), breaker `Plan` scaffolding, and C ABI scaffolding. TiFlash consumes TiForth behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridge, DAG→pipeline translation, and gtests for a common DAG shape. Note: blocked IO/await states are not wired; production translation remains incremental.
- Semantics + type contract: logical-type metadata contract for decimals/MyTime/collations; collation compare/sort-key/hashing; custom Arrow compute scalar kernels + rewrites for TiDB/TiFlash semantics (incl decimal arithmetic), with TiForth unit tests + TiFlash parity gtests.
- Hash keying performance + tests (TiForth pinned `1ae1b8a`): arena-backed open-addressing `detail::KeyHashTable` reused by hash agg + hash join; aggregate state layout framework and pooled containers; scratch key encoding uses Arrow-pool-backed `detail::ScratchBytes` and hash-agg output `binary` keys are arena slices (`detail::ByteSlice`). Added `KeyHashTable` stress tests and hash-agg memory-pool gtest. TiFlash pins TiForth to `1ae1b8a`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`.
- Docs sync (TiForth `8cefd3a`): updated `tiforth/docs/*` and `examples/README.md` to remove TiFlash `libs/tiforth` path assumptions and refresh hash agg/join operator coverage notes. Tests: `ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`. Files: (tiforth) `docs/{README,architecture,operators_and_functions,pipeline_apis,type_mapping_tidb_to_arrow}.md`, `examples/README.md`.
- Cleanup (TiForth `1ae1b8a`): deduplicated `ArrowMemoryPoolResource` into `include/tiforth/detail/arrow_memory_pool_resource.h` and reused it in hash agg/join/sort. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`.
- Objectives review (2026-01-19): MS1-11 + semantics/type contract + Arrow-pool routing are in place and parity-tested for the common DAG path. Remaining gaps are mostly engineering/coverage: aggregation is still a minimal subset vs TiFlash’s full `Aggregator` (aggregate function set + specialized aggregation methods), and should be ported next as a dedicated milestone to avoid drifting semantics/perf.
- MS12 design (2026-01-19): added dedicated “full aggregation core” milestone to keep TiForth hash aggregation aligned with TiFlash `Aggregator` shape (method selection + optimized hash tables + broader aggregate coverage). Files: `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-12-full-aggregation.md`.
- MS12A keying/hash tables (TiForth `0eeb174`): added TiFlash-shaped one-key aggregation methods: dense direct-map for bool/i8/u8/i16/u16, open-addressing fixed-key table for int/uint/float/double (normalized to `uint64_t`), and single-string-key fast path with collation normalization (binary/pad-binary avoid extra sort-key allocation). Multi-key still uses serialized normalized bytes via `detail::KeyHashTable`. Added `detail::FixedKeyHashTable` + gtests. TiFlash pin bumped to `0eeb174`. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: (tiforth) `include/tiforth/detail/fixed_key_hash_table.h`, `include/tiforth/operators/hash_agg.h`, `src/tiforth/operators/hash_agg.cc`, `tests/tiforth_fixed_key_hash_table_test.cpp`, `tests/CMakeLists.txt`; (tiflash) `libs/CMakeLists.txt`.
