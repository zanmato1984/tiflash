# Work in Progress
- MS9D: TiForth: extend hash agg + hash join to support 2-key composite keys on the common path (int32/uint64/decimal/binary), reuse collation normalization per key; add unit tests.

# To Do

# Completed
- MS9C: TiFlash (guarded): add `RunTiForthPipelineOnBlocks(...)` helper (Block -> Arrow -> TiForth task -> Arrow -> Block) and a gtest that asserts on `DB::Block` output (collation-aware string filter). Decisions: keep it test-only for now; validate stable Arrow schema across input blocks; treat `TaskState::kBlocked` as NOT_IMPLEMENTED. Files: dbms/src/Flash/TiForth/BlockPipelineRunner.{h,cpp}, dbms/src/Flash/tests/gtest_tiforth_block_runner.cpp, .codex/progress/daemon.md. Tests: `cmake -S . -B cmake-build-tiflash-tiforth-debug && ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && ./cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=TiForth*`.
- MS9B: TiFlash (guarded): add Arrow `RecordBatch` -> `DB::Block` conversion for common types (int/uint/float, decimal128/256, MyDate/MyDateTime packed uint64, binary string). Decisions: reconstruct TiFlash logical types from Arrow field metadata (`tiforth.*`) and keep collation id in a side-channel `options_by_name` map since `DB::Block` has no collation; only support canonical decimal widths (non-256 uses Arrow decimal128, 256 uses decimal256). Files: dbms/src/Flash/TiForth/ArrowBlockConversion.{h,cpp}, dbms/src/Flash/tests/gtest_tiforth_block_roundtrip.cpp. Tests: `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && ./cmake-build-tiflash-tiforth-debug/dbms/gtests_dbms --gtest_filter=TiForth*`.
- MS9A: design milestone 9 host integration plan (TiFlash first). Decisions: keep Arrow metadata as contract, add Block<->Arrow reverse mapping + a Block runner adapter (tests first), defer real pipeline translation until Block bridge is validated. Files: docs/design/2026-01-14-tiforth-milestone-9-host-integration.md, .codex/progress/daemon.md.
- Review: milestones 1-8 done (common path + type mapping); next gap is host integration beyond Arrow-only gtests (Block in/out + real translation). Derived MS9A-D tasks and prioritized Block<->Arrow bridge + composite keys.
- MS8B/MS8D/MS8E: type mapping + key semantics + integration test. Decisions: Strings map to Arrow `binary` with `tiforth.string.collation_id`; PAD SPACE BIN uses right-trim in compare/hash; MyDate/MyDateTime stay packed `uint64`; join builds key->row-index on concatenated build side and uses Arrow `Take` to materialize output (mixed-type safe, deterministic order); hash agg stores first-seen output key but normalizes for hashing/equality. Files: dbms/src/Flash/TiForth/ArrowTypeMapping.{h,cpp}, dbms/src/Flash/CMakeLists.txt, libs/tiforth/{include,src}/tiforth/operators/{hash_join,hash_agg,sort}.*, dbms/src/Flash/tests/gtest_tiforth_type_mapping.cpp, docs/design/2026-01-14-tiforth-milestone-8-type-mapping.md, .codex/progress/daemon.md. Tests: `ninja -C libs/tiforth/build-debug && ctest --test-dir libs/tiforth/build-debug`; `ninja -C cmake-build-tiflash-tiforth-debug gtests_dbms && gtests_dbms --gtest_filter=TiForth*`.
- MS2-6: TiForth pipeline framework + common-path operators (Projection/Filter/HashAgg/Sort/HashJoin) + TiFlash translation gtests. Key decisions: Arrow `RecordBatch` boundary, host-driven task stepping, EOS=`nullptr`, Arrow compute delegation where semantics match. Files: libs/tiforth/include/tiforth/*, libs/tiforth/src/tiforth/*, docs/design/2026-01-14-tiforth-milestone-{1,2,3,4,5,6}-*.md, dbms/src/Flash/tests/gtest_tiforth_pipeline_translate.cpp, .codex/progress/daemon.md.
- MS7: host integration hardening (Engine memory pool plumbing, spill hook skeleton, C ABI header + buildable `tiforth_capi` stubs). Key decisions: `EngineOptions.memory_pool` non-null; default `DenySpillManager`; C ABI versioned and forward-extensible; early `tiforth_capi` returns NOT_IMPLEMENTED but links. Files: libs/tiforth/include/tiforth/{engine.h,spill.h}, libs/tiforth/include/tiforth_c/tiforth.h, libs/tiforth/src/tiforth/{engine.cc}, libs/tiforth/src/tiforth_capi/*, libs/tiforth/tests/*, docs/design/2026-01-14-tiforth-milestone-7-memory-pool-spill-abi.md, .codex/progress/daemon.md.
- MS8 (foundation): type mapping contract + TiForth metadata helpers + collation-aware string predicate compare (BINARY + padding BIN). Key decisions: use Arrow field metadata keys (no Arrow ExtensionType yet); treat strings as `binary` + `collation_id`; implement compare hook for `equal/less/greater` to avoid Arrow kernel collation mismatch. Files: docs/design/2026-01-14-tiforth-milestone-8-type-mapping.md, libs/tiforth/include/tiforth/{type_metadata.h,collation.h}, libs/tiforth/src/tiforth/{type_metadata.cc,collation.cc,expr.cc}, libs/tiforth/tests/{tiforth_type_metadata_test.cpp,tiforth_collation_compare_test.cpp}, docs/design/2026-01-14-tiforth.md, .codex/progress/daemon.md.
