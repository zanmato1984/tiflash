# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

- TiForth: make `ArrowComputeAggTransformOp` streaming (no full input buffering) by feeding `RecordBatch` generator into Acero plan and emitting aggregated output batches; add unit tests and update MS14 design doc.
- TiForth: extend Arrow-compute aggregation operator to accept non-`FieldRef` expressions for group keys + aggregate args by compiling `Expr` to Arrow compute `Expression` and inserting a pre-projection stage; add unit tests (nulls, strings, multi-key).
- TiFlash: optionally wire Arrow-compute aggregation into DAG→pipeline translation behind a runtime switch for A/B runs; add one parity gtest validating results match native aggregation for a simple group-by query shape.

# Completed

- TiForth baseline delivered (MS1-13, 2026-01-19): standalone `tiforth` library with Engine/Pipeline/Plan/Task + C ABI skeleton; core operators (projection/filter/hash agg/join/sort) and breaker plan; Arrow-native type contract via field metadata (decimals/MyTime/collations) with custom Arrow compute kernels for TiDB/TiFlash semantics; memory pool routed through host-provided `arrow::MemoryPool`. TiFlash integrates behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridge + DAG→pipeline translation and parity gtests for a common DAG shape.
- TiForth “full aggregation core” progress (MS12/MS12A, 2026-01-19): ported TiFlash-shaped aggregation method selection and optimized hash tables (dense direct-map, fixed-key open addressing, single-string fast path; multi-key via serialized bytes in `detail::KeyHashTable`), plus broader aggregate coverage (decimal sum/avg inference + avg state, float min/max NaN alignment, metadata upsert). TiFlash parity gtests extended for avg/decimal/float and TiFlash pins TiForth accordingly.
- TiForth task blocked-state model (MS13, 2026-01-19): wired `Pipeline::MakeReader()` blocked states (IOIn/IOOut via `ExecuteIO`, Waiting via `Await`, WaitForNotify host-driven) and added `PilotAsyncTransformOp` + gtests for IO/error/notify propagation; docs/design updated.
- MS14 Arrow-compute group aggregation + benchmarks (2026-01-19): implemented TiForth `ArrowComputeAggTransformOp` via Arrow Acero (`table_source` + `aggregate`) because Arrow `hash_*` aggregate kernels cannot be executed via `CallFunction`; enabled ARROW_ACERO for the bundled Arrow build and linked `arrow_acero`. Added TiFlash `bench_dbms` benchmarks comparing TiFlash native aggregation vs TiForth Arrow-compute aggregation across types + key distributions (no spill). Validation: TiForth `ctest` pass; TiFlash `gtests_dbms`/`bench_dbms` build ok. Benchmark (DEBUG): TiForth ~2x on low-cardinality ints + Zipf, ~same on single-group, ~1.2x on strings. Files: `docs/design/2026-01-14-tiforth-milestone-14-arrow-compute-aggregation.md`, `docs/design/2026-01-14-tiforth.md`, `dbms/src/Flash/tests/bench_tiforth_arrow_compute_agg.cpp`, `dbms/CMakeLists.txt`; TiForth commit `0224a45`. Notes: operator currently buffers full input into a Table and only supports `FieldRef` (no computed expressions yet).
- Objectives review (2026-01-19): confirmed all “Overall Work Objectives” are achieved (independent TiForth repo + stable Engine/Pipeline/Task APIs, TiFlash integration behind `TIFLASH_ENABLE_TIFORTH`, logical-type metadata contract, host memory pool routing). Updated `docs/design/2026-01-14-tiforth.md` status and derived next To Do items focused on streaming Arrow-compute aggregation and optional TiFlash integration for A/B runs. Files: `.codex/progress/daemon.md`, `docs/design/2026-01-14-tiforth.md`.
- RELEASE benchmark run + analysis (2026-01-19): built `cmake-build-release` and ran `bench_dbms --benchmark_filter='^ArrowComputeAgg/.*'` (configured with `-DNO_WERROR=ON`). Results (items/s): int32/int64 single-group Native 146M vs TiForth 131M (~0.90x); int32/int64 uniform_low(16) 187M vs 201M (~1.08x); int32/int64 uniform_high 24.6M vs 28.1M (~1.14x); int32/int64 zipf(1024) 167M vs 201M (~1.21x); int64/float64 uniform_low(16) 185M vs 206M (~1.12x); int64/float64 zipf(1024) 165M vs 204M (~1.24x); string/int64 uniform_low(16) 151M vs 71.7M (~0.47x); string/int64 zipf(1024) 122M vs 58.4M (~0.48x). Unblocked release build by adding missing `<system_error>` include in Poco `Event.cpp` and relaxing Arrow Acero release-only `-Wunused-private-field` via TiForth Arrow build flags (TiForth commit `145f2ab`). Files: `.codex/progress/daemon.md`, `contrib/poco/Foundation/src/Event.cpp`.
