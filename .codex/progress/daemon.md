# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

- Wire `enable_tiforth_arrow_compute_agg` into real TiFlash TiForth executor once non-pass-through DAG→TiForth translation is enabled (today only test harness translation).

# Completed

- TiForth Arrow-compute agg expressions (2026-01-19): added a pre-projection stage so group keys + aggregate args can be arbitrary TiForth `Expr` (compiled to Arrow `compute::Expression` via `CompileExpr`) while Acero `aggregate` still consumes `FieldRef` keys/targets by index. Unit tests added for computed key/arg expressions, string keys, multi-key grouping, and NULL coverage. Validation: TiForth `ctest --preset debug` pass. Files: `docs/design/2026-01-14-tiforth-milestone-14-arrow-compute-aggregation.md`, `.codex/progress/daemon.md`. TiForth commit `71cb82a`.
- TiForth Arrow-compute agg streaming (2026-01-19): rewired `ArrowComputeAggTransformOp` to stream input into Acero via `SourceNodeOptions` + `PushGenerator<std::optional<arrow::compute::ExecBatch>>` (no `Table::FromRecordBatches`), and drain `DeclarationToReader` output batches (no forced output combining). Kept key renaming to `AggKey.name`, added cancellation checks on generator `Push/Close`, and updated gtest to not assume output ordering/batching. Design doc synced (MS14). Validation: TiForth `ctest --preset debug` pass. Files: `docs/design/2026-01-14-tiforth-milestone-14-arrow-compute-aggregation.md`, `.codex/progress/daemon.md`. TiForth commit `17e1e9f`.
- TiForth baseline delivered (MS1-13, 2026-01-19): standalone `tiforth` library with Engine/Pipeline/Plan/Task + C ABI skeleton; core operators (projection/filter/hash agg/join/sort) and breaker plan; Arrow-native type contract via field metadata (decimals/MyTime/collations) with custom Arrow compute kernels for TiDB/TiFlash semantics; memory pool routed through host-provided `arrow::MemoryPool`. TiFlash integrates behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridge + DAG→pipeline translation and parity gtests for a common DAG shape.
- TiForth “full aggregation core” progress (MS12/MS12A, 2026-01-19): ported TiFlash-shaped aggregation method selection and optimized hash tables (dense direct-map, fixed-key open addressing, single-string fast path; multi-key via serialized bytes in `detail::KeyHashTable`), plus broader aggregate coverage (decimal sum/avg inference + avg state, float min/max NaN alignment, metadata upsert). TiFlash parity gtests extended for avg/decimal/float and TiFlash pins TiForth accordingly.
- TiForth task blocked-state model (MS13, 2026-01-19): wired `Pipeline::MakeReader()` blocked states (IOIn/IOOut via `ExecuteIO`, Waiting via `Await`, WaitForNotify host-driven) and added `PilotAsyncTransformOp` + gtests for IO/error/notify propagation; docs/design updated.
- MS14 Arrow-compute group aggregation + benchmarks (2026-01-19): implemented TiForth `ArrowComputeAggTransformOp` via Arrow Acero (`table_source` + `aggregate`) because Arrow `hash_*` aggregate kernels cannot be executed via `CallFunction`; enabled ARROW_ACERO for the bundled Arrow build and linked `arrow_acero`. Added TiFlash `bench_dbms` benchmarks comparing TiFlash native aggregation vs TiForth Arrow-compute aggregation across types + key distributions (no spill). Validation: TiForth `ctest` pass; TiFlash `gtests_dbms`/`bench_dbms` build ok. Benchmark (DEBUG): TiForth ~2x on low-cardinality ints + Zipf, ~same on single-group, ~1.2x on strings. Files: `docs/design/2026-01-14-tiforth-milestone-14-arrow-compute-aggregation.md`, `docs/design/2026-01-14-tiforth.md`, `dbms/src/Flash/tests/bench_tiforth_arrow_compute_agg.cpp`, `dbms/CMakeLists.txt`; TiForth commit `0224a45`. Notes: operator currently buffers full input into a Table and only supports `FieldRef` (no computed expressions yet).
- Objectives review (2026-01-19): confirmed all “Overall Work Objectives” are achieved (independent TiForth repo + stable Engine/Pipeline/Task APIs, TiFlash integration behind `TIFLASH_ENABLE_TIFORTH`, logical-type metadata contract, host memory pool routing). Updated `docs/design/2026-01-14-tiforth.md` status and derived next To Do items focused on streaming Arrow-compute aggregation and optional TiFlash integration for A/B runs. Files: `.codex/progress/daemon.md`, `docs/design/2026-01-14-tiforth.md`.
- RELEASE benchmark run + analysis (2026-01-19): built `cmake-build-release` and ran `bench_dbms --benchmark_filter='^ArrowComputeAgg/.*'` (configured with `-DNO_WERROR=ON`). Results (items/s): int32/int64 single-group Native 146M vs TiForth 131M (~0.90x); int32/int64 uniform_low(16) 187M vs 201M (~1.08x); int32/int64 uniform_high 24.6M vs 28.1M (~1.14x); int32/int64 zipf(1024) 167M vs 201M (~1.21x); int64/float64 uniform_low(16) 185M vs 206M (~1.12x); int64/float64 zipf(1024) 165M vs 204M (~1.24x); string/int64 uniform_low(16) 151M vs 71.7M (~0.47x); string/int64 zipf(1024) 122M vs 58.4M (~0.48x). Unblocked release build by adding missing `<system_error>` include in Poco `Event.cpp` and relaxing Arrow Acero release-only `-Wunused-private-field` via TiForth Arrow build flags (TiForth commit `145f2ab`). Files: `.codex/progress/daemon.md`, `contrib/poco/Foundation/src/Event.cpp`.
- TiFlash Arrow-compute agg A/B switch (2026-01-19): added `enable_tiforth_arrow_compute_agg` setting and threaded it into the TiFlash-shaped DAG→TiForth pipeline translation (test harness) to toggle between `tiforth::HashAggTransformOp` and `tiforth::ArrowComputeAggTransformOp`. Added a simple parity gtest that flips the setting on and validates Arrow-compute group-by sum matches TiFlash native results; used field indices for refs to avoid schema-name mismatch in Block→Arrow conversion. Validation: `ninja -C cmake-build-debug gtests_dbms` ok; gtests `*ArrowComputeAggGroupByInt32Sum*` + `TiForthPipelineTranslateTest.*AggTransform*` pass. Files: `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/tests/gtest_tiforth_filter_agg_parity.cpp`, `dbms/src/Flash/tests/gtest_tiforth_pipeline_translate.cpp`.
- RELEASE benchmark rerun (streaming Acero, 2026-01-19): `cmake-build-release/dbms/bench_dbms --benchmark_filter='^ArrowComputeAgg/.*' --benchmark_min_time=0.2`. Results (items/s, TiForth/Native): int32/int64 single-group 148.0M vs 126.1M (~0.85x); int32/int64 uniform_low(16) 181.8M vs 194.6M (~1.07x); int32/int64 uniform_high 20.6M vs 24.7M (~1.20x); int32/int64 zipf(1024) 167.0M vs 201.1M (~1.20x); int64/float64 uniform_low(16) 185.1M vs 206.4M (~1.11x); int64/float64 zipf(1024) 167.2M vs 202.1M (~1.21x); string/int64 uniform_low(16) 158.2M vs 70.7M (~0.45x); string/int64 zipf(1024) 123.9M vs 58.0M (~0.47x). Notes: similar profile as prior run; string-key cases still ~2x slower for TiForth Arrow-compute agg. Files: `.codex/progress/daemon.md`.
- String-key slowdown investigation (2026-01-19): added `ArrowComputeAgg/TiForthDictKey/*` benchmarks that feed a **shared-dictionary** `DictionaryArray` key column into TiForth `ArrowComputeAggTransformOp` (built once per dataset, outside timed loop). Found Arrow/Acero currently errors on multi-batch inputs with *differing* dictionaries (`NotImplemented: Unifying differing dictionaries`), so per-batch `dictionary_encode` is not viable; using a shared dictionary across all batches works. RELEASE results (items/s): string uniform_low Native 161.7M vs TiForth 72.4M (~0.45x) vs TiForthDictKey 199.5M (~1.23x); string zipf Native 123.8M vs TiForth 58.1M (~0.47x) vs TiForthDictKey 193.9M (~1.57x). Files: `dbms/src/Flash/tests/bench_tiforth_arrow_compute_agg.cpp`, `.codex/progress/daemon.md`.
- Detailed benchmark report (2026-01-19): wrote a standalone markdown report for `bench_dbms` `^ArrowComputeAgg/.*` including environment, methodology, and result tables for Native vs TiForth vs TiForthDictKey (string shared dictionary) and notes on Arrow dictionary unification limitations. Files: `docs/design/2026-01-19-arrow-compute-agg-benchmark-report.md`, `.codex/progress/daemon.md`.
- Pushed `tiforth` branch (2026-01-19): pushed commits to upstream `ruoxi/tiforth` (remote `https://github.com/zanmato1984/tiflash.git`). Notes: includes TiFlash A/B switch + parity gtest + benchmark reruns + dict-key benchmark + benchmark report. Files: `.codex/progress/daemon.md`.
