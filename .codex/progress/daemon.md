# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

- (none)

# To Do

- Review “Overall Work Objectives” against current implementation; if any objective is not achieved, break it into actionable tasks and add them here; otherwise derive a new To Do list from current shortcomings (simplicity, readability, testability, perf gaps, missing operators).

# Completed

- TiForth core + TiFlash integration (MS1-11 common path): Engine/Pipeline/Task APIs, expression compilation, operators (projection/filter/hash agg/hash join/sort), breaker `Plan` scaffolding, and C ABI scaffolding. TiFlash consumes TiForth behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridge, DAG→pipeline translation, and gtests for a common DAG shape. Note: blocked IO/await states are not wired; production translation remains incremental.
- Semantics + type contract: logical-type metadata contract for decimals/MyTime/collations; collation compare/sort-key/hashing; custom Arrow compute scalar kernels + rewrites for TiDB/TiFlash semantics (incl decimal arithmetic), with TiForth unit tests + TiFlash parity gtests.
- Hash keying performance + tests (TiForth pinned `1ae1b8a`): arena-backed open-addressing `detail::KeyHashTable` reused by hash agg + hash join; aggregate state layout framework and pooled containers; scratch key encoding uses Arrow-pool-backed `detail::ScratchBytes` and hash-agg output `binary` keys are arena slices (`detail::ByteSlice`). Added `KeyHashTable` stress tests and hash-agg memory-pool gtest. TiFlash pins TiForth to `1ae1b8a`. Checks: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`.
- Docs sync (TiForth `8cefd3a`): updated `tiforth/docs/*` and `examples/README.md` to remove TiFlash `libs/tiforth` path assumptions and refresh hash agg/join operator coverage notes. Tests: `ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`. Files: (tiforth) `docs/{README,architecture,operators_and_functions,pipeline_apis,type_mapping_tidb_to_arrow}.md`, `examples/README.md`.
- Cleanup (TiForth `1ae1b8a`): deduplicated `ArrowMemoryPoolResource` into `include/tiforth/detail/arrow_memory_pool_resource.h` and reused it in hash agg/join/sort. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`.
- Objectives review (2026-01-19): MS1-11 + semantics/type contract + Arrow-pool routing are in place and parity-tested for the common DAG path. Remaining gaps are mostly engineering/coverage: aggregation is still a minimal subset vs TiFlash’s full `Aggregator` (aggregate function set + specialized aggregation methods), and should be ported next as a dedicated milestone to avoid drifting semantics/perf.
- MS12 design (2026-01-19): added dedicated “full aggregation core” milestone to keep TiForth hash aggregation aligned with TiFlash `Aggregator` shape (method selection + optimized hash tables + broader aggregate coverage). Files: `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-12-full-aggregation.md`.
- MS12A keying/hash tables (TiForth `0eeb174`): added TiFlash-shaped one-key aggregation methods: dense direct-map for bool/i8/u8/i16/u16, open-addressing fixed-key table for int/uint/float/double (normalized to `uint64_t`), and single-string-key fast path with collation normalization (binary/pad-binary avoid extra sort-key allocation). Multi-key still uses serialized normalized bytes via `detail::KeyHashTable`. Added `detail::FixedKeyHashTable` + gtests. TiFlash pin bumped to `0eeb174`. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`; `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: (tiforth) `include/tiforth/detail/fixed_key_hash_table.h`, `include/tiforth/operators/hash_agg.h`, `src/tiforth/operators/hash_agg.cc`, `tests/tiforth_fixed_key_hash_table_test.cpp`, `tests/CMakeLists.txt`; (tiflash) `libs/CMakeLists.txt`.
- TiForth hash agg aggregate coverage (TiForth `1824213`): added TiFlash decimal inference for `sum`/`avg` (output decimal precision/scale + decimal128/256 selection), implemented decimal avg state/finalization, aligned float min/max NaN behavior with TiFlash, and made `WithLogicalTypeMetadata` upsert keys to avoid duplicate metadata conflicts. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`. Files: (tiforth) `include/tiforth/operators/hash_agg.h`, `src/tiforth/operators/hash_agg.cc`, `tests/tiforth_hash_agg_test.cpp`, `src/tiforth/type_metadata.cc`, `docs/operators_and_functions.md`.
- TiFlash parity gtests for `avg`/float/decimal (2026-01-19): pinned TiForth to `1824213`, extended `gtest_tiforth_filter_agg_parity` with `avg` + float/decimal cases (including breaker), and fixed MockExecutor aggregation type binding: set `field_type` for `avg` and compute correct `sum/avg` return types for float+decimal. Also fixed mock decimal schema by allowing `MockColumnInfo` to carry decimal precision/scale (avoid legacy `flen=65, scale=0`). Tests: `ninja -C cmake-build-debug gtests_dbms && LOG_LEVEL=error cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForthPipelineTranslateTest.*:TiForthFilterAggParityTestRunner.*'`. Files: `.codex/progress/daemon.md`, `libs/CMakeLists.txt`, `dbms/src/Flash/tests/gtest_tiforth_filter_agg_parity.cpp`, `dbms/src/Debug/MockExecutor/AggregationBinder.cpp`, `dbms/src/Debug/MockStorage.{h,cpp}`.
- TiForth task blocked-state model (MS13, TiForth `ef8546a`, 2026-01-19): wired `Pipeline::MakeReader()` to drive blocked states (`kIOIn/kIOOut` via `ExecuteIO`, `kWaiting` via `Await`; `kWaitForNotify` remains host-driven and returns `NotImplemented` in the reader adapter) and added `PilotAsyncTransformOp` + gtests to validate IO/error/notify propagation. Tests: `cmake --build /Users/zanmato/dev/tiforth/build-debug && ctest --test-dir /Users/zanmato/dev/tiforth/build-debug`. Files: (tiforth) `include/tiforth/operators/pilot.h`, `src/tiforth/pipeline.cc`, `include/tiforth/tiforth.h`, `tests/{CMakeLists,tiforth_task_blocked_state_test}.cpp`, `docs/pipeline_apis.md`; (tiflash) `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-13-task-blocking-io.md`, `.codex/progress/daemon.md`.
