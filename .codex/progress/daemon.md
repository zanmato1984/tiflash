# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

# Completed

- MS25 ara-style operator rewrite (2026-01-23): drop legacy operator surface and make operators fully ara-like. Decisions: follow ara guidance that `SinkOp::ImplicitSource` is driven by the plan/stage graph (not `CompilePipeline`); keep HashAgg output column order (aggs then keys) for TiFlash DAG compatibility; keep legacy code under `tiforth/stash` for reference but exclude from install. Files (TiForth): `include/tiforth/{pipeline/op/op.h,plan.h,task.h,task/blocked_resumer.h,operators/*}`; `src/tiforth/{task.cc,plan.cc,pipeline.cc,pipeline/*,operators/*}`; tests updated under `tests/`. Files (TiFlash): planner `dbms/src/Flash/Planner/Plans/{PhysicalAggregation,PhysicalFilter,PhysicalProjection}.cpp`, executor `dbms/src/Flash/TiForth/*`, gtests/benches under `dbms/src/Flash/tests/*`, plus `docs/design/{2026-01-14-tiforth.md,2026-01-14-tiforth-milestone-25-ara-style-operator-rewrite.md}`. Validation: `cmake --build --preset debug -j 8 && ctest --preset debug --output-on-failure` (tiforth); `ninja -C cmake-build-debug gtests_dbms && cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForth*'` (tiflash).
- Review overall objectives (2026-01-23): confirmed MS1-25 objectives are achieved (standalone TiForth, TiFlash integration behind `TIFLASH_ENABLE_TIFORTH`, logical-type contract, memory pool routing); no new To Do items added.
- TiForth foundation + integration (MS1-23, 2026-01-19..2026-01-23): standalone Arrow-native library + type contract, TiFlash integration behind `TIFLASH_ENABLE_TIFORTH`, and ara-style runtime rewrite (`pipeline::OpOutput`/`PipelineTask`, `task::TaskGroup`/`TaskStatus`) with legacy-op adapters for non-ported operators. Decisions: keep TiForth independent of TiFlash; enforce “no sync in operators” (barriers only via TaskGroup boundaries). Files: TiForth `include/tiforth/{engine,plan,task,pipeline/*,task/*,operators/*,detail/*}` + `src/tiforth/*`; TiFlash integration/tests under `dbms/src/Flash/TiForth/*` and `dbms/src/Flash/tests/gtest_tiforth_*`. Validation (last known): `ctest --preset debug --output-on-failure` (tiforth) + `ninja -C cmake-build-debug gtests_dbms` + `cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForth*'`.
- MS24 ara-pipeline aggregation (2026-01-23): deprecate legacy agg surfaces (`TransformOp`/`OperatorStatus`) and run aggregation on ara-style pipeline ops. Decisions: keep legacy operator APIs/adapters for non-agg operators; make `PlanBuilder` stages accept either legacy or pipeline operator factories; HashAgg stays breaker-style with `HashAggContext` and a sink backend finalize. Files (TiForth): `include/tiforth/plan.h`, `src/tiforth/plan.cc`, `src/tiforth/task.cc`, `include/tiforth/operators/{arrow_compute_agg,hash_agg}.h`, `src/tiforth/operators/{arrow_compute_agg,hash_agg}.cc`, `tests/{tiforth_arrow_compute_agg_test,tiforth_hash_agg_test,tiforth_memory_pool_test,tiforth_parallel_hash_agg_pipeline_test}.cpp`. Files (TiFlash): `dbms/src/Flash/Planner/Plans/PhysicalAggregation.cpp`, `dbms/src/Flash/tests/{gtest_tiforth_block_runner,gtest_tiforth_filter_agg_parity,gtest_tiforth_hash_agg_parity,gtest_tiforth_pipeline_translate,gtest_tiforth_type_mapping,bench_tiforth_arrow_compute_agg,bench_tiforth_hash_agg_small_string}.cpp`, `docs/design/{2026-01-14-tiforth.md,2026-01-14-tiforth-milestone-24-deprecate-legacy-agg-ops-to-ara-pipeline.md}`. Validation: `cmake --preset debug && cmake --build --preset debug -j 8 && ctest --preset debug --output-on-failure` (tiforth); `ninja -C cmake-build-debug gtests_dbms` + `cmake-build-debug/dbms/gtests_dbms --gtest_filter='TiForth*'`.
