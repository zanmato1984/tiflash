# Overall Work Objectives

- Deliver TiForth as an independent Arrow-native compute library (standalone repo `zanmato1984/tiforth`, consumed by TiFlash via FetchContent / local `libs/tiforth` checkout) with stable host APIs (Engine/Pipeline/Task), Arrow compute integration, and a minimal C ABI surface.
- Integrate TiForth into TiFlash behind `TIFLASH_ENABLE_TIFORTH` with Block<->Arrow bridging, DAG->pipeline translation, and gtests covering a common TiFlash DAG shape.
- Preserve TiFlash/TiDB semantics via a clear logical-type contract (Arrow field metadata) for tricky types (decimals, packed MyTime temporals, collated strings: compare/hash/sort keys).
- Route TiForth allocations through host-provided `arrow::MemoryPool` to support accounting/limits/spill hooks.

# Work in Progress

# To Do

# Completed

- TiForth core + type contract (MS1-13, 2026-01-19): standalone `tiforth` library (Engine/Pipeline/Task + minimal C ABI), Arrow logical-type metadata contract (decimal/MyTime/collations), core operators (projection/filter/hash agg/join/sort) with breaker plan semantics + blocked-state model, and optimized hash tables. Decision: keep TiForth independent (no TiFlash assumptions) while matching Arrow style + rigid checks. Files: `libs/tiforth/*`, `docs/design/2026-01-14-tiforth.md`, `docs/design/2026-01-14-tiforth-milestone-*.md`.
- Arrow-native aggregation track (MS14-19, 2026-01-19..2026-01-21): ArrowComputeAgg (Acero) + non-Acero ArrowHashAgg (renamed to HashAgg in MS20), parity gtests, string-key stable-dict prototype, MS17 default switch (planner uses ArrowHashAgg by default; legacy renamed to `LegacyHashAggTransformOp` with migration alias), MS18 small-string single-key grouper (`SmallStringSingleKeyGrouper`) wired as ArrowHashAgg default for single binary/string key, MS19 small-string benchmarks + report update. Files: `libs/tiforth/src/tiforth/{operators,detail}/*`, `libs/tiforth/tests/tiforth_{arrow_compute_agg,hash_agg,small_string_single_key_grouper}_test.cpp`, `dbms/src/Flash/Planner/Plans/PhysicalAggregation.cpp`, `dbms/src/Flash/tests/{gtest_tiforth_hash_agg_parity,bench_tiforth_hash_agg_small_string}.cpp`, `docs/design/2026-01-19-arrow-compute-agg-benchmark-report.md`, `docs/design/2026-01-14-tiforth-milestone-{17,18,19}-*.md`. Validation: `ctest --test-dir libs/tiforth/build-debug --output-on-failure`; `ninja -C cmake-build-debug gtests_dbms` + `gtests_dbms --gtest_filter='TiForth*'`; `ninja -C cmake-build-release bench_dbms` + `bench_dbms --benchmark_filter '^(HashAgg|NativeAgg)/SmallStringSingleKey/.*'`. Notes: at MS19, collation-aware string grouping was legacy-only; MS21 adds collation-aware single-key grouping to HashAgg.
- TiFlash↔TiForth integration + executor runtime + DAG translate (2026-01-19..2026-01-21): Block↔Arrow bridge, query memory accounting via `TiFlashMemoryPool`, streaming Task stepping + blocked states mapping with gtests; “translate DAG to TiForth” mode for a small subset with native fallback. Files: `dbms/src/Flash/TiForth/*`, `dbms/src/Flash/tests/gtest_tiforth_*`, `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/executeQuery.cpp`.
- MS20 HashAgg breaker + rename (2026-01-21): remove legacy hash agg, rework Arrow-kernel-backed HashAgg into breaker-style (partial `HashAggTransformOp` + merge `HashAggMergeSinkOp` + output `HashAggResultSourceOp` on shared `HashAggContext`), and rename ArrowHashAgg → HashAgg across TiForth/TiFlash integration/settings/tests/bench/docs. Decision: TiFlash planner wires HashAgg as a breaker stage; ArrowComputeAgg stays pipeline-style. Files (TiFlash): `dbms/src/Flash/Planner/Plans/PhysicalAggregation.cpp`, `dbms/src/Flash/TiForth/TiForthAggBlockInputStream.h`, `dbms/src/Flash/TiForth/TiForthAggBlockInputStream.cpp`, `dbms/src/Interpreters/Settings.h`, `dbms/src/Flash/tests/gtest_tiforth_hash_agg_parity.cpp`, `dbms/src/Flash/tests/bench_tiforth_hash_agg_small_string.cpp`, `docs/design/2026-01-14-tiforth-milestone-20-remove-legacy-hash-agg-rename-hash-agg.md`. Files (TiForth): `include/tiforth/operators/hash_agg.h`, `src/tiforth/operators/hash_agg.cc` (+ delete `operators/arrow_hash_agg.*`). Notes: TiForth still returns `NotImplemented` for global agg (no keys); TiFlash gtests accept this. Validation: `cmake --preset debug && cmake --build --preset debug && ctest --preset debug --output-on-failure` (TiForth); `ninja -C cmake-build-debug gtests_dbms` + `gtests_dbms --gtest_filter='TiForth*'`; `ninja -C cmake-build-release bench_dbms` + `bench_dbms --benchmark_filter='^(HashAgg|NativeAgg)/SmallStringSingleKey/.*' --benchmark_min_time=0.2`.
- MS21 CollationSingleKeyGrouper (2026-01-21): implement collation-aware single-key GROUP BY by grouping on TiDB sort keys while preserving first-row original key in output; wire into HashAgg default grouper selection when key field has `tiforth.logical_type=string` and `tiforth.string.collation_id != 63`. Decision: only single-key binary/string supported; multi-key collation-aware grouping remains not implemented. Files (TiForth): `include/tiforth/detail/collation_single_key_grouper.h`, `src/tiforth/detail/collation_single_key_grouper.cc`, `src/tiforth/operators/hash_agg.cc`, `tests/tiforth_hash_agg_test.cpp`, `docs/operators_and_functions.md`. Files (TiFlash parity): `dbms/src/Flash/tests/gtest_tiforth_filter_agg_parity.cpp`. Validation: same as MS20 (plus `tiforth_hash_agg_test` includes a collated-key unit test).
